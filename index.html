<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reportes - MIDIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .logo-header {
            background-color: #004884;
            padding: 20px;
            color: white;
            margin-bottom: 30px;
        }
        .report-container {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .data-table th {
            background-color: #004884;
            color: white;
        }
        .export-buttons {
            margin-top: 30px;
            border-top: 2px solid #dee2e6;
            padding-top: 20px;
        }
        .btn-whatsapp {
            background-color: #25D366;
            color: white;
        }
        @media (max-width: 768px) {
            .col-md-3 {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-header text-center">
            <h3>Ministerio de Desarrollo e Inclusi√≥n Social</h3>
            <h5>Sistema de Reportes Territoriales</h5>
        </div>

        <div class="report-container">
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label class="form-label">Departamento</label>
                    <select id="departamento" class="form-select" onchange="cargarProvincias()">
                        <option value="">Seleccionar</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Provincia</label>
                    <select id="provincia" class="form-select" onchange="cargarDistritos()" disabled>
                        <option value="">Seleccione departamento</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label class="form-label">Distrito</label>
                    <select id="distrito" class="form-select" onchange="cargarFechas()" disabled>
                        <option value="">Seleccione provincia</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Fecha</label>
                    <select id="fecha" class="form-select" onchange="mostrarResultados()" disabled>
                        <option value="">Seleccione distrito</option>
                    </select>
                </div>
            </div>

            <div id="resultados"></div>

            <div class="export-buttons text-end d-none" id="exportButtons">
                <button class="btn btn-danger me-2" onclick="exportarPDF()">
                    <i class="bi bi-file-earmark-pdf"></i> PDF
                </button>
                <button class="btn btn-primary me-2" onclick="exportarWord()">
                    <i class="bi bi-file-earmark-word"></i> Word
                </button>
                <button class="btn btn-success" onclick="compartirWhatsApp()">
                    <i class="bi bi-whatsapp"></i> WhatsApp
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="dataset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        window.onload = function() {
            cargarDepartamentos();
        };

        function cargarDepartamentos() {
            const departamentos = [...new Set(dataset.map(item => item.departamento))];
            const select = document.getElementById('departamento');
            
            departamentos.sort().forEach(depto => {
                select.innerHTML += `<option value="${depto}">${depto}</option>`;
            });
        }

        function cargarProvincias() {
            const depto = document.getElementById('departamento').value;
            const selectProvincia = document.getElementById('provincia');
            
            selectProvincia.innerHTML = '<option value="">Seleccionar</option>';
            selectProvincia.disabled = !depto;
            
            const provincias = [...new Set(dataset
                .filter(item => item.departamento === depto)
                .map(item => item.provincia))];
            
            provincias.sort().forEach(prov => {
                selectProvincia.innerHTML += `<option value="${prov}">${prov}</option>`;
            });
            
            document.getElementById('distrito').disabled = true;
            document.getElementById('fecha').disabled = true;
            document.getElementById('resultados').innerHTML = '';
            document.getElementById('exportButtons').classList.add('d-none');
        }

        function cargarDistritos() {
            const depto = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const selectDistrito = document.getElementById('distrito');
            
            selectDistrito.innerHTML = '<option value="">Seleccionar</option>';
            selectDistrito.disabled = !provincia;
            
            const distritos = [...new Set(dataset
                .filter(item => item.departamento === depto && item.provincia === provincia)
                .map(item => item.distrito))];
            
            distritos.sort().forEach(dist => {
                selectDistrito.innerHTML += `<option value="${dist}">${dist}</option>`;
            });
            
            document.getElementById('fecha').disabled = true;
            document.getElementById('resultados').innerHTML = '';
            document.getElementById('exportButtons').classList.add('d-none');
        }

        function cargarFechas() {
            const depto = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const distrito = document.getElementById('distrito').value;
            const selectFecha = document.getElementById('fecha');

            selectFecha.innerHTML = '<option value="">Seleccionar</option>';
            selectFecha.disabled = !distrito;
            
            const fechas = [...new Set(dataset
                .filter(item => 
                    item.departamento === depto &&
                    item.provincia === provincia &&
                    item.distrito === distrito
                )
                .map(item => item.fecha))];
            
            fechas.sort().reverse().forEach(fecha => {
                selectFecha.innerHTML += `<option value="${fecha}">${new Date(fecha).toLocaleDateString('es-PE')}</option>`;
            });

            document.getElementById('resultados').innerHTML = '';
            document.getElementById('exportButtons').classList.add('d-none');
        }

        function mostrarResultados() {
            const depto = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const distrito = document.getElementById('distrito').value;
            const fecha = document.getElementById('fecha').value;
            
            const resultado = dataset.find(item => 
                item.departamento === depto &&
                item.provincia === provincia &&
                item.distrito === distrito &&
                item.fecha === fecha
            );

            if(resultado) {
                const html = `
                    <div class="table-responsive">
                        <table class="table data-table table-striped">
                            <thead>
                                <tr>
                                    <th colspan="2" class="text-center bg-primary text-white">Datos del Territorio</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(resultado).map(([key, value]) => `
                                    <tr>
                                        <td class="fw-bold">${formatearCampo(key)}</td>
                                        <td>${formatearValor(value, key)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('resultados').innerHTML = html;
                document.getElementById('exportButtons').classList.remove('d-none');
            }
        }

        function formatearCampo(key) {
            const campos = {
                ubigeo: 'C√≥digo UBIGEO',
                ut: 'Unidad Territorial',
                nfamilia_saf: 'Familias SAF',
                nni√±os_saf: 'Ni√±os SAF',
                ngestantes_saf: 'Gestantes SAF',
                ejecucion_saf: 'Ejecuci√≥n SAF (S/)',
                nni√±os_scd: 'Ni√±os SCD',
                nlocales_scd: 'Locales SCD',
                ejecucion_scd: 'Ejecuci√≥n SCD (S/)',
                fecha: 'Fecha de Reporte'
            };
            return campos[key] || key.toUpperCase();
        }

        function formatearValor(value, key) {
            if(typeof value === 'number') {
                if(key.includes('ejecucion')) {
                    return `S/ ${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                }
                return value.toLocaleString();
            }
            if(key === 'fecha') {
                return new Date(value).toLocaleDateString('es-PE');
            }
            return value;
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const resultado = obtenerDatosActuales();

            doc.setFontSize(16);
            doc.setTextColor(0, 72, 132);
            doc.text('Reporte Oficial - MIDIS', 15, 20);
            
            const columns = [['Campo', 'Valor']];
            const rows = Object.entries(resultado).map(([key, value]) => [
                formatearCampo(key),
                formatearValor(value, key)
            ]);
            
            doc.autoTable({
                head: columns,
                body: rows,
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [0, 72, 132] }
            });

            doc.save(`Reporte_${resultado.ubigeo}.pdf`);
        }

        function exportarWord() {
            const resultado = obtenerDatosActuales();
            const htmlContent = `
                <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial; }
                            h1 { color: #004884; }
                            table { border-collapse: collapse; width: 100%; }
                            td, th { border: 1px solid #ddd; padding: 8px; }
                            th { background-color: #004884; color: white; }
                        </style>
                    </head>
                    <body>
                        <h1>Reporte Oficial - MIDIS</h1>
                        <table>
                            ${Object.entries(resultado).map(([key, value]) => `
                                <tr>
                                    <th>${formatearCampo(key)}</th>
                                    <td>${formatearValor(value, key)}</td>
                                </tr>
                            `).join('')}
                        </table>
                        <p>Generado: ${new Date().toLocaleDateString()}</p>
                    </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Reporte_${resultado.ubigeo}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function compartirWhatsApp() {
            const resultado = obtenerDatosActuales();
            const fechaReporte = new Date().toLocaleDateString('es-PE');
            
            let mensaje = `*Reporte Territorial MIDIS*\n\n`;
            mensaje += `üó∫Ô∏è *Ubigeo:* ${resultado.ubigeo}\n`;
            mensaje += `üè¢ *Unidad Territorial:* ${resultado.ut}\n`;
            mensaje += `üìç *Ubicaci√≥n:* ${resultado.distrito}, ${resultado.provincia}, ${resultado.departamento}\n`;
            mensaje += `üìÖ *Fecha de Reporte:* ${new Date(resultado.fecha).toLocaleDateString('es-PE')}\n\n`;
            
            mensaje += `*üîµ Datos SAF:*\n`;
            mensaje += `üë®üë©üëßüë¶ Familias: ${resultado.nfamilia_saf.toLocaleString()}\n`;
            mensaje += `üßí Ni√±os: ${resultado.nni√±os_saf.toLocaleString()}\n`;
            mensaje += `ü§∞ Gestantes: ${resultado.ngestantes_saf.toLocaleString()}\n`;
            mensaje += `üí∏ Ejecuci√≥n: S/ ${resultado.ejecucion_saf.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}\n\n`;
            
            mensaje += `*üü° Datos SCD:*\n`;
            mensaje += `üßí Ni√±os: ${resultado.nni√±os_scd.toLocaleString()}\n`;
            mensaje += `üè´ Locales: ${resultado.nlocales_scd.toLocaleString()}\n`;
            mensaje += `üí∏ Ejecuci√≥n: S/ ${resultado.ejecucion_scd.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}\n\n`;
            
            mensaje += `üìÖ Generado: ${fechaReporte}`;

            const mensajeCodificado = encodeURIComponent(mensaje);
            window.open(`https://api.whatsapp.com/send?text=${mensajeCodificado}`, '_blank');
        }

        function obtenerDatosActuales() {
            const depto = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const distrito = document.getElementById('distrito').value;
            const fecha = document.getElementById('fecha').value;
            
            return dataset.find(item => 
                item.departamento === depto &&
                item.provincia === provincia &&
                item.distrito === distrito &&
                item.fecha === fecha
            );
        }
    </script>
</body>
</html>
