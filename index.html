<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sistema de Padrones - MIDIS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Estilos anteriores se mantienen igual */
        :root {
            --color-primario: rgba(255, 140, 0, 1);
            --color-secundario: rgba(119, 136, 153, 1);
            --color-fondo: #f8f9fc;
        }

        body {
            background-color: var(--color-fondo);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .logo-header {
            background: linear-gradient(135deg, var(--color-primario) 0%, #cc8a00 100%);
            padding: 1rem;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* ... resto de estilos ... */
    </style>
</head>
<body>
    <!-- Contenido HTML anterior se mantiene igual -->
    <div class="container-lg py-4">
        <!-- ... misma estructura HTML ... -->
    </div>

    <script>
        // Configuración inicial y funciones anteriores se mantienen
        let chartSAF, chartSCD;
        Chart.register(ChartDataLabels);

        // ... funciones cargarDepartamentos, cargarProvincias, etc ... 

        // Función exportarPDF modificada
        async function exportarPDF() {
            const resultado = obtenerResultadoActual();
            if (!resultado) {
                alert('Seleccione todos los filtros antes de exportar');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            try {
                // Encabezado
                doc.setFontSize(16);
                doc.setTextColor(0, 72, 132);
                doc.text('Reporte Oficial - MIDIS', 15, 20);
                
                // Tabla de datos
                const columns = [['Campo', 'Valor']];
                const filteredData = Object.entries(resultado).filter(([key]) => key !== 'fecha');
                const rows = filteredData.map(([key, value]) => [
                    formatearCampo(key),
                    formatearValor(value, key)
                ]);
                
                doc.autoTable({
                    head: columns,
                    body: rows,
                    startY: 30,
                    theme: 'grid',
                    styles: { fontSize: 10 }
                });

                // Capturar gráficos como imágenes
                const safCanvas = document.getElementById('chartSAF');
                const scdCanvas = document.getElementById('chartSCD');
                
                const safImage = await html2canvas(safCanvas);
                const scdImage = await html2canvas(scdCanvas);
                
                // Añadir gráficos al PDF
                const pageWidth = doc.internal.pageSize.getWidth();
                const imgWidth = pageWidth - 30;
                const imgHeight = (safCanvas.height * imgWidth) / safCanvas.width;
                
                doc.addPage();
                doc.addImage(safImage, 'PNG', 15, 20, imgWidth, imgHeight);
                
                doc.addPage();
                doc.addImage(scdImage, 'PNG', 15, 20, imgWidth, imgHeight);

                // Manejo para iOS
                if(/iPhone|iPad/i.test(navigator.userAgent)) {
                    const pdfBlob = doc.output('blob');
                    const pdfUrl = URL.createObjectURL(pdfBlob);
                    window.open(pdfUrl, '_blank');
                } else {
                    doc.save(`Reporte_${resultado.ubigeo}.pdf`);
                }
            } catch (error) {
                console.error('Error al generar PDF:', error);
                alert('Error al generar el PDF: ' + error.message);
            }
        }

        // Función exportarWord modificada
        function exportarWord() {
            const resultado = obtenerResultadoActual();
            if (!resultado) return;

            const htmlContent = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial; margin: 2rem; }
                            h1 { color: #004884; border-bottom: 2px solid #004884; }
                            table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background-color: #f8f9fc; }
                        </style>
                    </head>
                    <body>
                        <h1>Reporte PNCM - MIDIS</h1>
                        <h3>${resultado.departamento}, ${resultado.provincia}, ${resultado.distrito}</h3>
                        <table>
                            ${Object.entries(resultado).map(([key, value]) => `
                                <tr>
                                    <th>${formatearCampo(key)}</th>
                                    <td>${formatearValor(value, key)}</td>
                                </tr>
                            `).join('')}
                        </table>
                        <p><em>Generado el ${new Date().toLocaleDateString('es-PE')}</em></p>
                    </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            
            if(/iPhone|iPad/i.test(navigator.userAgent)) {
                window.open(url, '_blank');
            } else {
                const link = document.createElement('a');
                link.href = url;
                link.download = `Reporte_${resultado.ubigeo}.doc`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Función compartirWhatsApp modificada
        function compartirWhatsApp() {
            const resultado = obtenerResultadoActual();
            if (!resultado) {
                alert('Primero seleccione y genere un reporte válido');
                return;
            }

            const fechaReporte = new Date().toLocaleDateString('es-PE');
            const formatoMoneda = {
                style: 'currency',
                currency: 'PEN',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            };

            let mensaje = `*REPORTE PNCM - ${resultado.distrito.toUpperCase()}*\n\n`;
            mensaje += `📍 *Ubicación:* ${resultado.distrito}, ${resultado.provincia}, ${resultado.departamento}\n`;
            mensaje += `📅 *Fecha del Padrón:* ${new Date(resultado.fecha).toLocaleDateString('es-PE')}\n\n`;
            mensaje += `👨👩👧👦 Familias SAF: ${(resultado.nfamilia_saf || 0).toLocaleString()}\n`;
            mensaje += `🧒 Niños SCD: ${(resultado.nniños_scd || 0).toLocaleString()}\n\n`;
            mensaje += `📊 Ver detalles completos en: [Enlace a la app]`;

            const mensajeCodificado = encodeURIComponent(mensaje);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            if (isIOS) {
                window.location.href = `whatsapp://send?text=${mensajeCodificado}`;
                setTimeout(() => {
                    window.location.href = `https://api.whatsapp.com/send?text=${mensajeCodencoded}`;
                }, 1000);
            } else {
                window.open(`https://wa.me/?text=${mensajeCodificado}`, '_blank');
            }
        }

        // ... resto de funciones se mantienen igual ...
    </script>

    <!-- Scripts adicionales -->
    <script src="dataset.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
