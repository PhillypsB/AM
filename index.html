<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHILLYPS BRAVO</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        :root {
            --color-primario: rgba(255, 140, 0, 1);
            --color-secundario: rgba(119, 136, 153, 1);
            --color-fondo: #f8f9fc;
        }

        body {
            background-color: var(--color-fondo);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        /* Actualizar el encabezado */
    .encabezado-resultados {
        background: linear-gradient(135deg, var(--color-secundario) 0%, #616161 100%);
        padding: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
/* Estilos profesionales */
.grupo-saf, .grupo-scd {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.grupo-saf:hover, .grupo-scd:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 24px rgba(0,0,0,0.15) !important;
}

.metric-card {
    padding: 1rem;
    background: rgba(255,255,255,0.9);
    border-radius: 12px;
    transition: all 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
}

.metric-card:hover {
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: scale(1.02);
}

.metric-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
}

.bg-soft-pink {
    background: rgba(236, 8, 137, 0.1);
}

.bg-soft-green {
    background: rgba(0, 176, 80, 0.1);
}

.ejecucion-presupuestal {
    background: rgba(0,0,0,0.02);
    border-radius: 8px;
    padding: 0.75rem 1rem;
}
    .encabezado-resultados h5 {
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
        .grupo-saf {
            --color-grupo: #EC0889;
            background: rgba(236, 8, 137, 0.05);
            border-left: 4px solid var(--color-grupo);
        }
    
        .grupo-scd {
            --color-grupo: #00B050;
            background: rgba(0, 176, 80, 0.05);
            border-left: 4px solid var(--color-grupo);
        }
    
        .grupo-titulo {
            background: linear-gradient(90deg, rgba(var(--color-grupo-rgb), 0.1) 0%, transparent 100%);
            color: var(--color-grupo);
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
    
        .grupo-titulo i {
            font-size: 1.25rem;
        }
    
        .dato-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
    
        .dato-item:hover {
            background: rgba(255,255,255,0.7);
            transform: translateX(5px);
        }
    
        .valor-destacado {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-grupo);
        }
    
        .badge-estado {
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .logo-header {
            background: linear-gradient(135deg, var(--color-primario) 0%, #cc8a00 100%);
            padding: 1rem;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .logo-img {
            height: 45px;
            margin-right: 1rem;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .header-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .report-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .filter-card {
            background: rgba(0,72,132,0.03);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .graficos-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem 1.5rem 2.5rem 1.5rem; /* Más espacio abajo */
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            height: 380px;
            position: relative;
        }

        .chart-container canvas {
            max-height: 320px !important;
            max-width: 100% !important;
        }
        .badge-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        
        .badge i {
            vertical-align: middle;
            font-size: 1.1em;
        }
        .data-table th {
            background-color: var(--color-primario);
            color: white;
        }
        .list-group-item {
            border: none;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            font-size: 0.9rem;
        }
        
        .list-group-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 576px) {
            .report-container {
                padding: 1rem;
            }
            
            .filter-card {
                padding: 1rem;
            }
            
            .header-title {
                font-size: 1.2rem;
            }
            
            .badge-status {
                padding: 0.35rem 0.75rem;
                font-size: 0.8rem;
            }
            
            .list-group-item {
                flex-direction: column;
                align-items: flex-start !important;
                padding: 0.75rem 1rem;
            }
            
            .list-group-item div:last-child {
                margin-top: 0.25rem;
            }
        }
    </style>
</head><!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5B9TG9ET4F"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5B9TG9ET4F');
</script>
<body>
    <div class="container-lg py-4">
        <div class="logo-header rounded-3">
            <div class="d-flex align-items-center justify-content-center">
                <img src="https://previews.123rf.com/images/mrcocoa/mrcocoa1605/mrcocoa160500291/55924712-consulta-online-icono-adecuado-para-informaci%C3%B3n-de-gr%C3%A1ficos-p%C3%A1ginas-web-y-medios-impresos-vector.jpg" 
                     alt="Logo" 
                     class="logo-img">
                <div>
                    <h2 class="header-title mb-1">COBERTURA DEL PROGRAMA NACIONAL CUNA MÁS</h2>
                    <h5 class="header-subtitle">2023 | 2024 | 2025</h5>
                </div>
            </div>
        </div>
<!-- Resumen Nacional -->
<div class="report-container mb-4" id="resumenNacional">
    <div class="encabezado-resultados text-white mb-4">
        <h5 class="mb-0"><i class="bi bi-bar-chart-line me-2"></i>COBERTURA A NIVEL NACIONAL - JUNIO 2025</h5>
    </div>

    <div class="row g-4">
        <!-- Tarjeta SAF Mejorada -->
        <div class="col-md-6">
            <div class="grupo-saf h-100 shadow-lg" style="border-radius: 15px;">
                <div class="card-header bg-gradient-primary text-white py-3" 
                     style="border-radius: 15px 15px 0 0; background: linear-gradient(135deg, #EC0889 0%, #BD0670 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-house-heart fs-4 me-3"></i>
                            <h5 class="mb-0 fw-semibold">SERVICIO DE ACOMPAÑAMIENTO A FAMILIAS</h5>
                        </div>
                        <span id="estadoSAF" class="badge bg-white text-primary fs-6 py-2 px-3">
                            <i class="bi bi-clipboard2-data me-2"></i>SAF
                        </span>
                    </div>
                </div>
                
                <div class="card-body px-4 py-3">
                    <div class="row g-3">
                        <!-- Métricas -->
                        <div class="col-4 text-center metric-card">
                            <div class="metric-icon bg-soft-pink mb-2">
                                <i class="bi bi-people-fill fs-5 text-primary"></i>
                            </div>
                            <div class="text-muted small fw-medium mb-1">FAMILIAS</div>
                            <div id="nacionalSAFfamilias" class="h4 mb-0 fw-bold text-dark">0</div>
                        </div>
                        
                        <div class="col-4 text-center metric-card">
                            <div class="metric-icon bg-soft-pink mb-2">
                                <i class="bi bi-balloon fs-5 text-primary"></i>
                            </div>
                            <div class="text-muted small fw-medium mb-1">NIÑOS</div>
                            <div id="nacionalSAFninos" class="h4 mb-0 fw-bold text-dark">0</div>
                        </div>
                        
                        <div class="col-4 text-center metric-card">
                            <div class="metric-icon bg-soft-pink mb-2">
                                <i class="bi bi-gender-female fs-5 text-primary"></i>
                            </div>
                            <div class="text-muted small fw-medium mb-1">GESTANTES</div>
                            <div id="nacionalSAFgestantes" class="h4 mb-0 fw-bold text-dark">0</div>
                        </div>
                        
                        <!-- Ejecución Presupuestal -->
                        <div class="col-12 mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small fw-medium">
                                    <i class="bi bi-cash-coin me-2"></i>EJECUCIÓN PRESUPUESTAL
                                </div>
                                <div id="nacionalSAFejecucion" class="h5 mb-0 fw-bold text-success">S/ 0.00</div>
                            </div>
                                <div><small><br>
                                <b>Distritos Atendidos/Focalizados:</b> 1,357 / 1,837 (73.87%)<BR>
                                <b>Meta:</b> 277,283 (100.9%)<BR>
                                <b>Población Objetivo:</b> 601,141</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Tarjeta SCD Mejorada -->
        <div class="col-md-6">
            <div class="grupo-scd h-100 shadow-lg" style="border-radius: 15px;">
                <div class="card-header bg-gradient-success text-white py-3" 
                     style="border-radius: 15px 15px 0 0; background: linear-gradient(135deg, #00B050 0%, #008C3A 100%);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-building fs-4 me-3"></i>
                            <h5 class="mb-0 fw-semibold">SERVICIO DE CUIDADO DIURNO</h5>
                        </div>
                        <span id="estadoSCD" class="badge bg-white text-success fs-6 py-2 px-3">
                            <i class="bi bi-clipboard2-check me-2"></i>SCD
                        </span>
                    </div>
                </div>
                
                <div class="card-body px-4 py-3">
                    <div class="row g-3">
                        <!-- Métricas -->
                        <div class="col-6 text-center metric-card">
                            <div class="metric-icon bg-soft-green mb-2">
                                <i class="bi bi-balloon fs-5 text-success"></i>
                            </div>
                            <div class="text-muted small fw-medium mb-1">NIÑOS ATENDIDOS</div>
                            <div id="nacionalSCDninos" class="h4 mb-0 fw-bold text-dark">0</div>
                        </div>
                        
                        <div class="col-6 text-center metric-card">
                            <div class="metric-icon bg-soft-green mb-2">
                                <i class="bi bi-house-door fs-5 text-success"></i>
                            </div>
                            <div class="text-muted small fw-medium mb-1">LOCALES</div>
                            <div id="nacionalSCDlocales" class="h4 mb-0 fw-bold text-dark">0</div>
                        </div>
                        
                        <!-- Ejecución Presupuestal -->
                        <div class="col-12 mt-3 pt-3 border-top">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="text-muted small fw-medium">
                                    <i class="bi bi-cash-coin me-2"></i>EJECUCIÓN PRESUPUESTAL
                                </div>
                                <div id="nacionalSCDejecucion" class="h5 mb-0 fw-bold text-success">S/ 0.00</div>
                            </div>
                            
                                <div><small><br>
                                <b>Distritos Atendidos/Focalizados:</b> 456 / 1,697 (26.87%)<br>
                                <b>Continuidad:</b> 74/77(96.10%)<BR>
                                <b>Meta:</b> 67,387 (97.1%)<BR>
                                <b>Población Objetivo:</b> 281,334</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Históricos Nacionales -->
    <div class="graficos-section mt-4">
        <div class="chart-container">
            <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>Evolución Nacional SAF - Familias</h5>
            <canvas id="chartHistorialSAF"></canvas>
        </div>
        <div class="chart-container">
            <h5 class="mb-3"><i class="bi bi-graph-up me-2"></i>Evolución Nacional SCD - Niños</h5>
            <canvas id="chartHistorialSCD"></canvas>
        </div>
    </div>
	<!-- Dentro del div#resumenNacional después de los gráficos -->
    <div class="text-center mt-4">
        <div class="export-buttons d-flex justify-content-center gap-2">
            <button class="btn btn-danger" onclick="exportarPDFNacional()">
                <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
            </button>
            <button class="btn btn-primary" onclick="exportarWordNacional()">
                <i class="bi bi-file-earmark-word me-2"></i>Exportar Word
            </button>
            <button class="btn btn-success" onclick="compartirWhatsAppNacional()">
                <i class="bi bi-whatsapp me-2"></i>Compartir
            </button>
        </div>
    </div>
</div>
        <div class="report-container">
            <div class="filter-card">
                <div class="encabezado-resultados text-white mb-4">
                    <h5 class="mb-0"><i class="bi bi-funnel-fill me-2"></i>BÚSQUEDA DE INTERVENCIÓN A NIVEL DISTRITAL</h5>
                </div>
                <div class="row g-4">
                    <div class="col-md-3">
                        <label class="form-label fw-medium">Departamento</label>
                        <select id="departamento" class="form-select" onchange="cargarProvincias()">
                            <option value="">Seleccionar</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-medium">Provincia</label>
                        <select id="provincia" class="form-select" onchange="cargarDistritos()" disabled>
                            <option value="">Seleccione departamento</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-medium">Distrito</label>
                        <select id="distrito" class="form-select" onchange="cargarFechas()" disabled>
                            <option value="">Seleccione provincia</option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-medium">Fecha del Padrón</label>
                        <select id="fecha" class="form-select" onchange="mostrarResultados()" disabled>
                            <option value="">Seleccione distrito</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="resultados"></div>

            <div class="graficos-section d-none" id="graficosSection">
                <div class="chart-container">
                    <h5 class="mb-3">Evolución SAF - Familias Atendidas</h5>
                    <canvas id="chartSAF"></canvas>
                </div>
                <div class="chart-container">
                    <h5 class="mb-3">Evolución SCD - Niños Atendidos</h5>
                    <canvas id="chartSCD"></canvas>
                </div>
            </div>

            <div class="export-buttons text-end d-none mt-4" id="exportButtons">
                <button class="btn btn-danger me-2" onclick="exportarPDF()">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Exportar PDF
                </button>
                <button class="btn btn-primary me-2" onclick="exportarWord()">
                    <i class="bi bi-file-earmark-word me-2"></i>Exportar Word
                </button>
                <button class="btn btn-success" onclick="compartirWhatsApp()">
                    <i class="bi bi-whatsapp me-2"></i>Compartir
                </button>
            </div>
        </div>
    </div>

    <script>
	let nacionalData = {}; // Añadir al inicio del script

	function exportarPDFNacional() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(16);
    doc.text('Resumen Nacional - PNCM', 15, 20);
    
    const data = [
        ['Indicador', 'Valor'],
        ['Familias SAF', nacionalData.safFamilias.toLocaleString()],
        ['Niños SAF', nacionalData.safNinos.toLocaleString()],
        ['Gestantes SAF', nacionalData.safGestantes.toLocaleString()],
        ['Ejecución SAF', `S/ ${nacionalData.ejecucionSAF.toFixed(2)}`],
        ['Niños SCD', nacionalData.scdNinos.toLocaleString()],
        ['Locales SCD', nacionalData.scdLocales.toLocaleString()],
        ['Ejecución SCD', `S/ ${nacionalData.ejecucionSCD.toFixed(2)}`]
    ];
    
    doc.autoTable({
        head: [data[0]],
        body: data.slice(1),
        startY: 30,
        theme: 'grid'
    });
    
    doc.save('Resumen_Nacional_PNCM.pdf');
}
function exportarWordNacional() {
    const htmlContent = `
        <!DOCTYPE html>
        <html>
            <head>
                <meta charset="UTF-8">
                <style>
                    body { font-family: Arial; margin: 2rem; }
                    h1 { color: #004884; border-bottom: 2px solid #004884; }
                    table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                    th { background-color: #f8f9fc; }
                </style>
            </head>
            <body>
                <h1>Resumen Nacional PNCM</h1>
                <h3>Reporte Consolidado</h3>
                <table>
                    ${Object.entries(nacionalData).map(([key, value]) => `
                        <tr>
                            <th>${formatearCampo(key)}</th>
                            <td>${formatearValor(value, key)}</td>
                        </tr>
                    `).join('')}
                </table>
                <p><em>Generado el ${new Date().toLocaleDateString('es-PE')}</em></p>
            </body>
        </html>
    `;

    const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Resumen_Nacional_PNCM.doc`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function compartirWhatsAppNacional() {
    const mensaje = `*RESUMEN NACIONAL PNCM*\n\n` +
        `📅 Período: ${nacionalData.ultimoMes ? formatearFechaHumana(nacionalData.ultimoMes) : 'N/A'}\n\n` +
        `🔵 *SAF*\n` +
        `👨👩👧👦 Familias: ${nacionalData.safFamilias?.toLocaleString() || '0'}\n` +
        `🧒 Niños: ${nacionalData.safNinos?.toLocaleString() || '0'}\n` +
        `🤰 Gestantes: ${nacionalData.safGestantes?.toLocaleString() || '0'}\n` +
        `💸 Ejecución: S/ ${nacionalData.ejecucionSAF?.toFixed(2) || '0.00'}\n\n` +
        `🟢 *SCD*\n` +
        `🏫 Locales: ${nacionalData.scdLocales?.toLocaleString() || '0'}\n` +
        `🧒 Niños: ${nacionalData.scdNinos?.toLocaleString() || '0'}\n` +
        `💸 Ejecución: S/ ${nacionalData.ejecucionSCD?.toFixed(2) || '0.00'}\n\n` +
        `📊 Datos actualizados al ${new Date().toLocaleDateString('es-PE', {day: '2-digit', month: '2-digit', year: 'numeric'})}`;

    const esIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const urlBase = esIOS ? 'whatsapp://send' : 'https://api.whatsapp.com/send';
    
    const urlCompleta = `${urlBase}?text=${encodeURIComponent(mensaje)}`;
    window.open(urlCompleta, '_blank');
}
	// Función para actualizar el resumen nacional
function actualizarResumenNacional() {
    // Calcular totales nacionales por mes
    const datosMensuales = dataset.reduce((acumulador, registro) => {
        const mes = registro.fecha.substring(0, 7); // Formato YYYY-MM
        if (!acumulador[mes]) {
            acumulador[mes] = {
                safFamilias: 0,
                safNinos: 0,
                safGestantes: 0, 
                scdNinos: 0,
                scdLocales: 0,
                ejecucionSAF: 0,
                ejecucionSCD: 0
            };
        }
        
        acumulador[mes].safFamilias += registro.nfamilia_saf || 0;
        acumulador[mes].safNinos += registro.nniños_saf || 0;
        acumulador[mes].safGestantes += registro.ngestantes_saf || 0;
        acumulador[mes].scdNinos += registro.nniños_scd || 0;
        acumulador[mes].scdLocales += registro.nlocales_scd || 0;
        acumulador[mes].ejecucionSAF += registro.ejecucion_saf || 0;
        acumulador[mes].ejecucionSCD += registro.ejecucion_scd || 0;
        
        return acumulador;
    }, {});

    // Obtener el último mes disponible
    const meses = Object.keys(datosMensuales).sort();
    const ultimoMes = meses[meses.length - 1];
    const datosUltimoMes = datosMensuales[ultimoMes];

    // Formatear valores (corregido)
    const formatearMoneda = (valor) => 
        `S/ ${valor.toLocaleString('es-PE', {minimumFractionDigits: 2})}`; // ✅ Se eliminó el paréntesis extra

    // Actualizar valores SAF
    document.getElementById('nacionalSAFfamilias').textContent = 
        datosUltimoMes.safFamilias.toLocaleString();
    document.getElementById('nacionalSAFninos').textContent = 
        datosUltimoMes.safNinos.toLocaleString();
    document.getElementById('nacionalSAFgestantes').textContent = 
        datosUltimoMes.safGestantes.toLocaleString();
    document.getElementById('nacionalSAFejecucion').textContent = 
        formatearMoneda(datosUltimoMes.ejecucionSAF);

    // Actualizar valores SCD
    document.getElementById('nacionalSCDninos').textContent = 
        datosUltimoMes.scdNinos.toLocaleString();
    document.getElementById('nacionalSCDlocales').textContent = 
        datosUltimoMes.scdLocales.toLocaleString();
    document.getElementById('nacionalSCDejecucion').textContent = 
        formatearMoneda(datosUltimoMes.ejecucionSCD);

    // Actualizar estados
    //document.getElementById('estadoSAF').innerHTML = //datosUltimoMes.ejecucionSAF >= 50000 
    //    ? '<i class="bi bi-check-circle me-1"></i>CUMPLE' 
    //    : '<i class="bi bi-x-circle me-1"></i>NO CUMPLE';
    
    //document.getElementById('estadoSCD').innerHTML = //datosUltimoMes.ejecucionSCD >= 30000 
    //    ? '<i class="bi bi-check-circle me-1"></i>CUMPLE' 
     //   : '<i class="bi bi-x-circle me-1"></i>NO CUMPLE';

    // Actualizar gráficos históricos
    actualizarGraficosHistoricosNacionales(
        meses.map(m => formatearFechaHumana(m)),
        meses.map(m => datosMensuales[m].safFamilias),
        meses.map(m => datosMensuales[m].scdNinos)
    );
	// Al final de la función, guardar los datos
    nacionalData = {
        safFamilias: datosUltimoMes.safFamilias,
        safNinos: datosUltimoMes.safNinos,
        safGestantes: datosUltimoMes.safGestantes, 
        ejecucionSAF: datosUltimoMes.ejecucionSAF,
        scdNinos: datosUltimoMes.scdNinos,
        scdLocales: datosUltimoMes.scdLocales,
        ejecucionSCD: datosUltimoMes.ejecucionSCD,
        ultimoMes: ultimoMes // Agregar esta línea
    };
}

// Función para actualizar los gráficos nacionales
function actualizarGraficosHistoricosNacionales(labels, safData, scdData) {
    const opcionesComunes = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
        legend: { display: false },
        datalabels: {
            anchor: 'end',
            align: 'top',
            offset: 6,
            formatter: (value) => value.toLocaleString(),
            font: { weight: 'bold', size: 10 }
        }
    },
    animation: {
        duration: 1000,
        easing: 'easeOutBack'
    },
    elements: {
        line: {
            tension: 0.4
        }
    },
        scales: {
            x: { grid: { display: false } },
            y: { beginAtZero: true }
        }
    };

    // Gráfico SAF
    new Chart(document.getElementById('chartHistorialSAF'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Familias SAF',
                data: safData,
                borderColor: '#EC0889',
                backgroundColor: '#EC088920',
                tension: 0.3,
                borderWidth: 2
            }]
        },
        options: opcionesComunes
    });

    // Gráfico SCD
    new Chart(document.getElementById('chartHistorialSCD'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Niños SCD',
                data: scdData,
                borderColor: '#00B050',
                backgroundColor: '#00B05020',
                tension: 0.3,
                borderWidth: 2
            }]
        },
        options: opcionesComunes
    });
}
        function formatearFechaHumana(fechaStr) {
            const meses = {
                '01': 'ENE', '02': 'FEB', '03': 'MAR', '04': 'ABR',
                '05': 'MAY', '06': 'JUN', '07': 'JUL', '08': 'AGO',
                '09': 'SEP', '10': 'OCT', '11': 'NOV', '12': 'DIC'
            };
            const [año, mes] = fechaStr.split('-');
            return `${año}-${meses[mes]}`;
        }
        
        let chartSAF, chartSCD;
        Chart.register(ChartDataLabels);

        // Cargar departamentos iniciales
        function cargarDepartamentos() {
            const departamentos = [...new Set(dataset.map(item => item.departamento))];
            const select = document.getElementById('departamento');
            
            departamentos.sort().forEach(depto => {
                select.innerHTML += `<option value="${depto}">${depto}</option>`;
            });
        }

        function cargarProvincias() {
            const depto = document.getElementById('departamento').value;
            const selectProvincia = document.getElementById('provincia');
            
            selectProvincia.innerHTML = '<option value="">Seleccionar</option>';
            selectProvincia.disabled = !depto;
            
            const provincias = [...new Set(dataset
                .filter(item => item.departamento === depto)
                .map(item => item.provincia))];
            
            provincias.sort().forEach(prov => {
                selectProvincia.innerHTML += `<option value="${prov}">${prov}</option>`;
            });
            
            document.getElementById('distrito').disabled = true;
            document.getElementById('fecha').disabled = true;
            resetearResultados();
        }

        function cargarDistritos() {
            const depto = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const selectDistrito = document.getElementById('distrito');
            
            selectDistrito.innerHTML = '<option value="">Seleccionar</option>';
            selectDistrito.disabled = !provincia;
            
            const distritos = [...new Set(dataset
                .filter(item => item.departamento === depto && item.provincia === provincia)
                .map(item => item.distrito))];
            
            distritos.sort().forEach(dist => {
                selectDistrito.innerHTML += `<option value="${dist}">${dist}</option>`;
            });
            
            document.getElementById('fecha').disabled = true;
            resetearResultados();
        }

        function cargarFechas() {
            const depto = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const distrito = document.getElementById('distrito').value;
            const selectFecha = document.getElementById('fecha');

            selectFecha.innerHTML = '<option value="">Seleccionar</option>';
            selectFecha.disabled = !distrito;
            
            const fechas = [...new Set(dataset
                .filter(item => 
                    item.departamento === depto &&
                    item.provincia === provincia &&
                    item.distrito === distrito
                )
                .map(item => item.fecha))];
            
                fechas.sort().reverse().forEach(fecha => {
                    const fechaFormateada = formatearFechaHumana(fecha.split('-')[0] + '-' + fecha.split('-')[1]);
                    selectFecha.innerHTML += `<option value="${fecha}">${fechaFormateada}</option>`;
                });

            resetearResultados();
        }

        function resetearResultados() {
            document.getElementById('resultados').innerHTML = '';
            document.getElementById('exportButtons').classList.add('d-none');
            document.getElementById('graficosSection').classList.add('d-none');
        }

        function mostrarResultados() {
            const fechaSeleccionada = document.getElementById('fecha').value;
            if(!fechaSeleccionada) return;

            const resultado = dataset.find(item => 
                item.departamento === document.getElementById('departamento').value &&
                item.provincia === document.getElementById('provincia').value &&
                item.distrito === document.getElementById('distrito').value &&
                item.fecha === fechaSeleccionada
            );

            if(resultado) {
                mostrarTablaResultados(resultado);
                actualizarGraficos();
                document.getElementById('exportButtons').classList.remove('d-none');
                document.getElementById('graficosSection').classList.remove('d-none');
            }
        }

        function mostrarTablaResultados(resultado) {
            const html = `
                <div class="mt-4 rounded-3 overflow-hidden shadow-sm">
                    <!-- Encabezado Naranja -->
                    <div class="encabezado-resultados text-white">
                        <div class="d-flex flex-column text-center">
                            <small>${resultado.ut}</small>
                            <h5 class="mb-0 fw-bold">${resultado.distrito}</h5>
                            <div class="small opacity-85">
                                ${resultado.provincia}, ${resultado.departamento}
                            </div>
                        </div>
                    </div>
                
                     <!-- Grupo SAF -->
        <div class="grupo-saf">
            <div class="grupo-titulo">
                <i class="bi bi-people-fill"></i>
                SERVICIO ACOMPAÑAMIENTO FAMILIA - SAF
            </div>
            
            ${[
                { key: 'nfamilia_saf', label: 'Familias SAF' },
                { key: 'nniños_saf', label: 'Niños SAF' },
                { key: 'ngestantes_saf', label: 'Gestantes SAF' },
                { key: 'CG_SAF', label: 'Comité Gestión SAF', default: 0 },
                { key: 'FACILITADOR_SAF', label: 'Facilitadores SAF', default: 0 },
                { key: 'ejecucion_saf', label: 'Ejecución SAF' },
                { key: 'CUMPLE_SAF', label: 'Focalización SAF' }
            ].map(({ key, label, defaultVal = 0 }) => `
                <div class="dato-item d-flex justify-content-between align-items-center">
                    <div>${label}</div>
                    <div class="valor-destacado">
                        ${formatearValor(resultado[key] ?? defaultVal, key)}
                    </div>
                </div>
            `).join('')}
        </div>

        <!-- Grupo SCD -->
        <div class="grupo-scd">
            <div class="grupo-titulo">
                <i class="bi bi-bandaid-fill"></i>
                SERVICIO CUIDADO DIURNO - SCD
            </div>
            
            ${[
                { key: 'nniños_scd', label: 'Niños SCD' },
                { key: 'nlocales_scd', label: 'Locales SCD' },
                { key: 'CIAI_SCD', label: 'CIAI SCD', default: 0 },
                { key: 'SA_SCD', label: 'SA SCD', default: 0 },
                { key: 'MadresCuidadoras_SCD', label: 'Madres Cuidadoras', default: 0 },
                { key: 'CG_SCD', label: 'Comité Gestión SCD', default: 0 },
                { key: 'ejecucion_scd', label: 'Ejecución SCD' },
                { key: 'CUMPLE_SCD', label: 'Focalización SCD' }
            ].map(({ key, label, defaultVal = 0 }) => `
                <div class="dato-item d-flex justify-content-between align-items-center">
                    <div>${label}</div>
                    <div class="valor-destacado">
                        ${formatearValor(resultado[key] ?? defaultVal, key)}
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    document.getElementById('resultados').innerHTML = html;
}

        function actualizarGraficos() {
            if(chartSAF) chartSAF.destroy();
            if(chartSCD) chartSCD.destroy();

            const datos = obtenerDatosHistoricos();
            
            const config = {
                type: 'line',
                plugins: [ChartDataLabels],
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
							offset: 6, // Añadir offset
                            formatter: (value) => value.toLocaleString(),
                            font: {
                                weight: 'bold',
                                size: 10
                            }
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            max: (ctx) => Math.max(...ctx.chart.data.datasets[0].data) * 1.2
                        } 
                    }
                }
            };

            chartSAF = new Chart(document.getElementById('chartSAF'), {
                ...config,
                data: {
                    labels: datos.labels,
                    datasets: [{
                        data: datos.saf,
                        borderColor: 'rgb(255, 140, 0)',
                        backgroundColor: 'rgba(255, 140, 0, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                }
            });

            chartSCD = new Chart(document.getElementById('chartSCD'), {
                ...config,
                data: {
                    labels: datos.labels,
                    datasets: [{
                        data: datos.scd,
                        borderColor: 'rgb(119, 136, 153)',
                        backgroundColor: 'rgba(119, 136, 153, 0.1)',
                        tension: 0.4,
                        fill: false,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                }
            });
        }

        function obtenerDatosHistoricos() {
            const ubicacion = {
                depto: document.getElementById('departamento').value,
                provincia: document.getElementById('provincia').value,
                distrito: document.getElementById('distrito').value
            };

            const datosFiltrados = dataset.filter(item => 
                item.departamento === ubicacion.depto &&
                item.provincia === ubicacion.provincia &&
                item.distrito === ubicacion.distrito
            );

            const datosPorPeriodo = {};
            datosFiltrados.forEach(item => {
                const fecha = new Date(item.fecha);
                const periodo = `${String(fecha.getMonth() + 1).padStart(2, '0')}/${fecha.getFullYear()}`;
                
                if(!datosPorPeriodo[periodo]) {
                    datosPorPeriodo[periodo] = { saf: 0, scd: 0 };
                }
                
                datosPorPeriodo[periodo].saf += item.nfamilia_saf || 0;
                datosPorPeriodo[periodo].scd += item.nniños_scd || 0;
            });

            const periodosOrdenados = Object.keys(datosPorPeriodo).sort((a, b) => {
                const [mesA, añoA] = a.split('/');
                const [mesB, añoB] = b.split('/');
                return new Date(añoA, mesA - 1) - new Date(añoB, mesB - 1);
            });

            return {
                saf: periodosOrdenados.map(p => datosPorPeriodo[p].saf),
                scd: periodosOrdenados.map(p => datosPorPeriodo[p].scd),
                labels: periodosOrdenados
            };
        }

        function formatearCampo(key) {
            const campos = {
                ubigeo: 'Código UBIGEO',
                ut: 'Unidad Territorial',
                nfamilia_saf: 'Familias SAF',
                nniños_saf: 'Niños SAF',
                ngestantes_saf: 'Gestantes SAF',
                ejecucion_saf: 'Ejecución SAF (S/)',
                CG_SAF: 'Comité Gestión SAF',
                FACILITADOR_SAF: 'Facilitadores SAF',
                nniños_scd: 'Niños SCD',
                nlocales_scd: 'Locales SCD',
                ejecucion_scd: 'Ejecución SCD (S/)',
                CIAI_SCD: 'CIAI SCD',
                SA_SCD: 'SA SCD',
                MadresCuidadoras_SCD: 'Madres Cuidadoras',
                CG_SCD: 'Comité Gestión SCD',
                CUMPLE_SAF: 'Focalización SAF',
                CUMPLE_SCD: 'Focalización SCD',
                fecha: 'PADRON AL'
            };
            return campos[key] || key.toUpperCase();
        }

        function formatearValor(value, key) {
            if(typeof value === 'number') {
                if(key.includes('ejecucion')) {
                    return `S/ ${value.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
                }
                return value.toLocaleString();
            }
            if (key === 'CUMPLE_SAF' || key === 'CUMPLE_SCD') {
    const color = key === 'CUMPLE_SAF' ? '#EC0889' : '#00B050';

    if (value === "1") {
        return `<span class="badge-estado" style="background: ${color}20; color: ${color};">
                    <i class="bi bi-check-circle-fill me-1"></i>FOCALIZADO
                </span>`;
    } else if (value === "2") {
        return `<span class="badge-estado" style="background: ${color}20; color: ${color};">
                    <i class="bi bi-arrow-repeat me-1"></i>CONTINUIDAD
                </span>`;
    } else {
        return `<span class="badge-estado" style="background: #FF000020; color: #FF0000;">
                    <i class="bi bi-x-circle-fill me-1"></i>NO FOCALIZADO
                </span>`;
    }
}
            if(key === 'fecha') {
                return formatearFechaHumana(value.split('T')[0].substring(0, 7));
            }
            return value; // <-- Esta línea faltaba
        }

        function obtenerResultadoActual() {
            const depto = document.getElementById('departamento').value;
            const provincia = document.getElementById('provincia').value;
            const distrito = document.getElementById('distrito').value;
            const fecha = document.getElementById('fecha').value;

            return dataset.find(item => 
                item.departamento === depto &&
                item.provincia === provincia &&
                item.distrito === distrito &&
                item.fecha === fecha
            );
        }
        
        // Función exportarPDF mejorada
        function exportarPDF() {
            const resultado = obtenerResultadoActual();
            if (!resultado) {
                alert('Seleccione todos los filtros antes de exportar');
                return;
            }
        
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración inicial
            doc.setFontSize(16);
            doc.setTextColor(0, 72, 132);
            doc.text('Reporte Oficial - MIDIS', 15, 20);
            
            // Configurar tabla
            const columns = [['Campo', 'Valor']];
            const filteredData = Object.entries(resultado).filter(([key]) => key !== 'fecha');
            const rows = filteredData.map(([key, value]) => [
                formatearCampo(key),
                formatearValor(value, key)
            ]);
            
            // Generar tabla
            doc.autoTable({
                head: columns,
                body: rows,
                startY: 30,
                theme: 'grid',
                styles: { 
                    fontSize: 10,
                    cellPadding: 3,
                    valign: 'middle'
                },
                headStyles: { 
                    fillColor: [0, 72, 132],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                alternateRowStyles: {
                    fillColor: [245, 245, 245]
                },
                margin: { horizontal: 15 },
                tableWidth: 'auto'
            });
        
            // Captura asincrónica de gráficos
            setTimeout(() => {
                const safCanvas = document.getElementById('chartSAF');
                const scdCanvas = document.getElementById('chartSCD');
                
                if (safCanvas && scdCanvas) {
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const imgWidth = pageWidth - 30;
                    const imgHeight = 100;
                    
                    // Gráfico SAF
                    doc.addPage();
                    const safImg = safCanvas.toDataURL('image/png', 1.0);
                    doc.text('Evolución SAF - Familias Atendidas', 15, 20);
                    doc.addImage(safImg, 'PNG', 15, 30, imgWidth, imgHeight);
                    
                    // Gráfico SCD
                    doc.addPage();
                    const scdImg = scdCanvas.toDataURL('image/png', 1.0);
                    doc.text('Evolución SCD - Niños Atendidos', 15, 20);
                    doc.addImage(scdImg, 'PNG', 15, 30, imgWidth, imgHeight);
                }
        
                // Guardar PDF
                doc.save(`Reporte_${resultado.ubigeo}_${new Date().toISOString().slice(0,10)}.pdf`);
            }, 500); // Retardo aumentado para asegurar renderizado
        }

        // Función exportarWord mejorada
        function exportarWord() {
            const resultado = obtenerResultadoActual();
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial; margin: 2rem; }
                            h1 { color: #004884; border-bottom: 2px solid #004884; }
                            table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
                            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                            th { background-color: #f8f9fc; }
                        </style>
                    </head>
                    <body>
                        <h1>Reporte PNCM - MIDIS</h1>
                        <h3>${resultado.departamento}, ${resultado.provincia}, ${resultado.distrito}</h3>
                        <table>
                            ${Object.entries(resultado).map(([key, value]) => `
                                <tr>
                                    <th>${formatearCampo(key)}</th>
                                    <td>${formatearValor(value, key)}</td>
                                </tr>
                            `).join('')}
                        </table>
                        <p><em>Generado el ${new Date().toLocaleDateString('es-PE')}</em></p>
                    </body>
                </html>
            `;

            const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Reporte_${resultado.ubigeo}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Función compartirWhatsApp mejorada
       function compartirWhatsApp() {
    const resultado = obtenerResultadoActual();
    if (!resultado) return;

    // 1. Construcción del mensaje multiplataforma
    const mensaje = `
*REPORTE COBERTURA PNCM*

🗺️ *Ubigeo:* ${resultado.ubigeo || 'N/A'}
🏢 *Unidad Territorial:* ${resultado.ut || 'N/A'}
📍 *Ubicación:* ${resultado.distrito}, ${resultado.provincia}, ${resultado.departamento}
📅 *Padrón:* ${formatearFechaHumana(resultado.fecha.split('T')[0].substring(0, 7))}

*🔵 DATOS SAF*
👨👩👧👦 *Familias:* ${(resultado.nfamilia_saf || 0).toLocaleString()}
🧒 *Niños:* ${(resultado.nniños_saf || 0).toLocaleString()}
🤰 *Gestantes:* ${(resultado.ngestantes_saf || 0).toLocaleString()}
🏛 *Comité Gestión:* ${resultado.CG_SAF || 0}
👥*Facilitadores:* ${resultado.FACILITADOR_SAF || 0}
💸 *Ejecución:* ${(resultado.ejecucion_saf || 0).toLocaleString('es-PE', {
        style: 'currency',
        currency: 'PEN'
    })}

*🟡 DATOS SCD*
🧒 *Niños:* ${(resultado.nniños_scd || 0).toLocaleString()}
🏘 *CIAI:* ${resultado.CIAI_SCD || 0}
🏠 *SA:* ${resultado.SA_SCD || 0}
👩 *Madres Cuidadoras:* ${resultado.MadresCuidadoras_SCD || 0}
🏛 *Comité Gestión:* ${resultado.CG_SCD || 0}
💸 *Ejecución:* ${(resultado.ejecucion_scd || 0).toLocaleString('es-PE', {
        style: 'currency',
        currency: 'PEN'
    })}

*📍 ESTADO DE FOCALIZACIÓN*
        🔵 SAF: ${
            resultado.CUMPLE_SAF === "1" 
                ? '✅ FOCALIZADO' 
                : resultado.CUMPLE_SAF === "2" 
                    ? '🔁 CONTINUIDAD' 
                    : '❌ NO FOCALIZADO'
        }
        🟡 SCD: ${
            resultado.CUMPLE_SCD === "1" 
                ? '✅ FOCALIZADO' 
                : resultado.CUMPLE_SCD === "2" 
                    ? '🔁 CONTINUIDAD' 
                    : '❌ NO FOCALIZADO'
        }

📅 *Generado:* ${new Date().toLocaleDateString('es-PE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    })}
    `.trim();

    // 2. Codificación universal
    const textoCodificado = encodeURIComponent(mensaje);
    
    // 3. Enlace único multiplataforma
    const enlaceWhatsApp = `https://api.whatsapp.com/send?text=${textoCodificado}`;
    
    // 4. Método de apertura inteligente
    window.open(enlaceWhatsApp, '_blank', 'noopener,noreferrer');
}

        window.onload = () => {
    actualizarResumenNacional();
    cargarDepartamentos();
};
    </script>

    <!-- Scripts adicionales -->
    <script src="dataset_junio.js"></script>
	
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
